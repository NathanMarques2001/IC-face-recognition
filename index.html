<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="./lib/opencv.min.js"></script>
  <title>OpenCV JS</title>
</head>

<body>
  <video id="webcam" width="480px" height="320px"></video>
  <canvas id="canvas" width="480px" height="320px"></canvas>

  <script>
    const webcam = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    let imagemOriginal = new cv.Mat(webcam.height, webcam.width, cv.CV_8UC4);
    let imagemProcessada = new cv.Mat(webcam.height, webcam.width, cv.CV_8UC4);
    let imagemCinza = new cv.Mat();
    let capturaVideo = new cv.VideoCapture(webcam);
    let rostos = new cv.RectVector();
    let classificadorRosto = new cv.CascadeClassifier();
    classificadorRosto.load('./haarcascades/haarcascade_frontalface_default.xml');

    (async () => {

      const stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
      });

      let imagemOriginal = new cv.Mat(webcam.height, webcam.width, cv.CV_8UC4);
      let capturaVideo = new cv.VideoCapture(webcam);

      webcam.srcObject = stream;
      webcam.play();

      const FPS = 30;

      function processarVideo() {
        try {
          if (!stream) {
            // Para os processos se o stream for encerrado.
            imagemOriginal.delete();
            imagemProcessada.delete();
            imagemCinza.delete();
            rostos.delete();
            classificadorRosto.delete();
            return;
          }
          let inicio = Date.now();
          // Iniciar o processamento.
          capturaVideo.read(imagemOriginal);
          imagemOriginal.copyTo(imagemProcessada);
          cv.cvtColor(imagemProcessada, imagemCinza, cv.COLOR_RGBA2GRAY, 0);
          //Reconhecimento de rosto
          // -> (BUG) classificadorRosto.detectMultiScale(imagemCinza, rostos, 1.1, 3, 0);
          // Desenhar retângulos nos rostos.
          for (let i = 0; i < rostos.size(); ++i) {
            let rosto = rostos.get(i);
            let ponto1 = new cv.Point(rosto.x, rosto.y);
            let ponto2 = new cv.Point(rosto.x + rosto.width, rosto.y + rosto.height);
            cv.rectangle(imagemProcessada, ponto1, ponto2, [255, 0, 0, 255]);
          }
          cv.imshow('canvas', imagemProcessada);
          // Calcula o tempo para o próximo processamento.
          let atraso = 1000 / FPS - (Date.now() - inicio);
          setTimeout(processarVideo, atraso);
        } catch (err) {
          console.log(err);
        }
      };

      // Iniciar o processamento.
      setTimeout(processarVideo, 0);
    })();
  </script>
</body>

</html>